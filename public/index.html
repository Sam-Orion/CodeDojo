<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeDojo</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white h-screen flex flex-col">

    <header class="bg-gray-800 p-4 shadow-md flex items-center space-x-4">
        <h1 class="text-xl font-bold">CodeDojo</h1>
        <div class="flex-grow"></div>
        <input id="roomIdInput" type="text" placeholder="Enter Room ID" class="bg-gray-700 border border-gray-600 rounded px-3 py-1 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
        <button id="joinBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-4 rounded">
            Join Session
        </button>
    </header>

    <main id="editor-container" class="flex-grow"></main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.33.0/min/vs/loader.min.js"></script>
    <script>
        const roomIdInput = document.getElementById('roomIdInput');
        const joinBtn = document.getElementById('joinBtn');
        const editorContainer = document.getElementById('editor-container');
        
        let editor;
        // --- NEW: Variables for WebSocket and state management ---
        let ws; // Will hold our WebSocket connection
        let ignoreChangeEvent = false; // Our switch to prevent infinite loops

        // --- Editor Initialization (same as before) ---
        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.33.0/min/vs' }});
        require(['vs/editor/editor.main'], function() {
            editor = monaco.editor.create(editorContainer, {
                value: `// Welcome to CodeDojo, your own Collaborative IDE!\n// Enter a Room ID and click "Join Session" to start.`,
                language: 'javascript',
                theme: 'vs-dark',
                automaticLayout: true
            });
            console.log("Monaco Editor loaded successfully.");

            // --- NEW: Listen for content changes in the editor ---
            // This event fires every time the user types, pastes, or deletes text.
            editor.onDidChangeModelContent(event => {
                // If the change was caused by a remote update, we ignore it.
                if (ignoreChangeEvent) {
                    return;
                }
                // Otherwise, we send the new content to the server.
                if (ws && ws.readyState === WebSocket.OPEN) {
                    const content = editor.getValue();
                    ws.send(JSON.stringify({
                        type: 'update',
                        roomId: roomIdInput.value.trim(),
                        content: content
                    }));
                }
            });
        });

        // --- NEW: Updated "Join" button logic ---
        joinBtn.addEventListener('click', () => {
            const roomId = roomIdInput.value.trim();
            if (!roomId) {
                alert('Please enter a Room ID.');
                return;
            }
            console.log(`Attempting to join room: ${roomId}`);
            
            // Connect to the WebSocket server
            // Note: In a real deployment, you'd use 'wss://' for a secure connection.
            ws = new WebSocket(`ws://${window.location.host}`);

            // --- WebSocket Event Handlers ---

            // 1. When the connection is successfully opened
            ws.onopen = () => {
                console.log('WebSocket connection established.');
                // Send a 'join' message to the server
                ws.send(JSON.stringify({ type: 'join', roomId: roomId }));
                // Visually indicate that we are connected
                joinBtn.textContent = 'Connected';
                joinBtn.disabled = true;
                roomIdInput.disabled = true;
                joinBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                joinBtn.classList.add('bg-green-600');
            };

            // 2. When a message is received from the server
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'update') {
                    // This is the crucial part for avoiding the infinite loop.
                    ignoreChangeEvent = true; // Set the flag
                    const currentPosition = editor.getPosition(); // Save cursor position
                    editor.setValue(data.content); // Update the editor content
                    editor.setPosition(currentPosition); // Restore cursor position
                    ignoreChangeEvent = false; // Unset the flag
                }
            };

            // 3. When the connection closes
            ws.onclose = () => {
                console.log('WebSocket connection closed.');
                alert('Connection to the server has been lost.');
                // Reset the UI to allow re-joining
                joinBtn.textContent = 'Join Session';
                joinBtn.disabled = false;
                roomIdInput.disabled = false;
                joinBtn.classList.remove('bg-green-600');
                joinBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            };

            // 4. If an error occurs
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                alert('An error occurred with the connection.');
            };
        });
    </script>
</body>
</html>

